import{a as O,R as W,r as x,w as A,u as T,h as E,k as F,j as o,l as y,cU as U,d as H,F as j,I as N,bU as I,e as V,f as B,bZ as z}from"./index-12050af9.js";var k={30:"black",31:"red",32:"green",33:"yellow",34:"blue",35:"magenta",36:"cyan",37:"white",90:"grey"},D={40:"black",41:"red",42:"green",43:"yellow",44:"blue",45:"magenta",46:"cyan",47:"white"},G=function(b){O(a,b);function a(t){var e=b.call(this,t)||this;return e.isDone=!1,e.autoScroll=!1,e.state={lastLine:"",logs:[],originLastLine:"",originLogs:[],refresh:!0,showLineNumber:!1,filterWord:""},e.refresh=function(r){var i=e.state.refresh;e.setState({refresh:!i}),i||(e.clear(r),e.loadLogs()),r.preventDefault()},e.clear=function(r){e.setState({logs:e.logs=[],lastLine:e.lastLine="",originLogs:[],originLastLine:""}),r==null||r.preventDefault()},e.filterWord=function(r,i,s){var n=r,g=i;s!==""&&s!==void 0&&s!==null&&s.length>0&&(r=r.filter(function(m){return m.includes(s)}),i.includes(s)||(i="")),e.setState({filterWord:s,lastLine:e.lastLine=i,logs:e.logs=r,originLogs:n,originLastLine:g})},e.addLines=function(r){r=r.concat();var i=e.props.maxLength,s=e.lastLine||"",n=(e.logs||[]).concat();r.length===1?(s+=r[0],e.setState({lastLine:e.lastLine=s})):(r[0]=s+(r[0]||""),s=r.pop()||"",i&&n.length+r.length>i&&n.splice(0,n.length+r.length-i),n=n.concat(r),e.filterWord(n,s,e.state.filterWord))},e.logRef=W.createRef(),e.autoScroll=t.autoScroll||!1,e.pauseOrResumeScrolling=e.pauseOrResumeScrolling.bind(e),e}return a.prototype.componentWillUnmount=function(){this.logRef&&this.logRef.current&&this.logRef.current.removeEventListener("scroll",this.pauseOrResumeScrolling)},a.prototype.componentDidMount=function(){if(this.autoScroll&&this.logRef&&this.logRef.current&&this.logRef.current.addEventListener("scroll",this.pauseOrResumeScrolling),this.props.source){var t=typeof this.props.source=="string"?x(this.props.source,this.props.data,"| raw"):this.props.source;t&&A(t)?this.loadLogs():(typeof t=="string"||Array.isArray(t)&&t.every(function(e){return typeof e=="string"}))&&(this.clear(),this.addLines(Array.isArray(t)?t:[t]))}},a.prototype.componentDidUpdate=function(t){if(this.autoScroll&&this.logRef&&this.logRef.current&&(this.logRef.current.scrollTop=this.logRef.current.scrollHeight),!!this.props.source){var e=typeof this.props.source=="string"?x(this.props.source,this.props.data,"| raw"):this.props.source;if(e&&A(e))T(t.source,this.props.source,t.data,this.props.data)&&this.loadLogs();else if(typeof e=="string"||Array.isArray(e)&&e.every(function(i){return typeof i=="string"})){var r=x(t.source,t.data,"| raw");r!==e&&e&&(this.clear(),this.addLines(Array.isArray(e)?e:[e]))}}},a.prototype.pauseOrResumeScrolling=function(){if(this.logRef&&this.logRef.current){var t=this.logRef.current,e=t.scrollHeight,r=t.scrollTop,i=t.offsetHeight;this.autoScroll=e-(r+i)<50}},a.prototype.loadLogs=function(){var t,e,r;return E(this,void 0,void 0,function(){var i,s,n,g,m,w,u,c,l,R,d,S,f,C,L,h,p,_=this;return F(this,function(v){switch(v.label){case 0:return i=this.props,s=i.source,n=i.data,g=i.env,m=i.translate,w=i.encoding,i.maxLength,u=i.credentials,c=u===void 0?"include":u,l=z(s,n),l.url?[4,fetch(l.url,{method:((t=l.method)===null||t===void 0?void 0:t.toLocaleUpperCase())||"GET",headers:l.headers||void 0,body:l.data?JSON.stringify(l.data):void 0,credentials:c})]:[2];case 1:if(R=v.sent(),R.status!==200)return[3,8];if(d=R.body,!d)return[2];S=d.getReader(),v.label=2;case 2:return this.state.refresh?[3,4]:[4,S.cancel("click cancel button").then(function(){_.props.env.notify("success","日志已经停止刷新")})];case 3:v.sent(),v.label=4;case 4:return[4,S.read()];case 5:if(f=v.sent(),C=f.done,L=f.value,L&&(h=new TextDecoder(w).decode(L,{stream:!0}),p=h.split(`
`),this.addLines(p)),C)return this.isDone=!0,[2];v.label=6;case 6:return[3,2];case 7:return[3,9];case 8:!l.silent&&g.notify("error",(r=(e=l==null?void 0:l.messages)===null||e===void 0?void 0:e.failed)!==null&&r!==void 0?r:m("fetchFailed")),v.label=9;case 9:return[2]}})})},a.prototype.ansiColrToHtml=function(t){var e=this.props.disableColor;if(e===!0)return t;var r=t.match(/\u001b\[([^m]+)m/);if(r){var i=r[1];if(i){if(t=t.replace(/\u001b[^m]*?m/g,""),i in k)return o("span",{style:{color:k[i]},children:t});if(i in D)return o("span",{style:{backgroundColor:D[i]},children:t.replace(/\u001b[^m]*?m/g,"")})}}return t},a.prototype.renderHighlightWord=function(t){var e=this,r=this.props.classnames,i=this.state.filterWord;if(i==="")return this.ansiColrToHtml(t);var s=t.split(i);return s.map(function(n,g){return g<s.length-1?y("span",{children:[e.ansiColrToHtml(n),o("span",{className:r("Log-line-highlight"),children:i})]}):n})},a.prototype.renderLine=function(t,e,r){var i=this.props,s=i.classnames;return i.disableColor,y("div",{className:s("Log-line"),children:[r&&y("span",{className:s("Log-line-number"),children:[t+1," "]}),this.renderHighlightWord(e)]},t)},a.prototype.render=function(){var t=this,e=this.props,r=e.source,i=e.className,s=e.style,n=e.classnames,g=e.placeholder,m=e.height,w=e.rowHeight;e.disableColor;var u=e.translate,c=e.operation,l=this.state,R=l.refresh,d=l.showLineNumber,S=u(g);r||(S=u("Log.mustHaveSource"));var f,C=this.state.lastLine?this.state.logs.concat([this.state.lastLine]):this.state.logs,L=w;return L?f=o(U,{height:m,itemCount:C.length,itemSize:w,renderItem:function(h){var p=h.index,_=h.style;return y("div",{className:n("Log-line"),style:H(H({},_),{whiteSpace:"nowrap"}),children:[d&&y("span",{className:n("Log-line-number"),children:[p+1," "]}),t.renderHighlightWord(C[p])]},p)}}):f=C.map(function(h,p){return t.renderLine(p,h,d)}),y("div",{className:n("Log",i),style:s,children:[o("div",{className:n("Log-operation"),children:c&&(c==null?void 0:c.length)>0&&y(j,{children:[c.includes("stop")&&o("a",{title:u("stop"),className:R?"":"is-disabled",onClick:this.refresh,children:o(N,{icon:"pause"})}),c.includes("restart")&&o("a",{title:u("reload"),className:R?"is-disabled":"",onClick:this.refresh,children:o(N,{icon:"refresh"})}),c.includes("showLineNumber")&&o("a",{title:u(d?"Log.notShowLineNumber":"Log.showLineNumber"),onClick:function(h){t.setState({showLineNumber:!d}),h.preventDefault()},children:o(N,{icon:d?"invisible":"view"})}),c.includes("clear")&&o("a",{onClick:this.clear,title:u("clear"),children:o(N,{icon:"remove"})}),c&&c.includes("filter")&&o(I,{className:n("Log-filter-box"),placeholder:"过滤词",onChange:function(h){return t.filterWord(t.state.originLogs,t.state.lastLine,h)},value:this.state.filterWord})]})}),o("div",{ref:this.logRef,className:n("Log-body"),style:{height:L?"auto":m},children:L||f.length?f:S})]})},a.defaultProps={height:500,autoScroll:!0,placeholder:"loading",encoding:"utf-8"},a}(W.Component),M=function(b){O(a,b);function a(){return b!==null&&b.apply(this,arguments)||this}return a=V([B({type:"log"})],a),a}(G);export{G as Log,M as LogRenderer};

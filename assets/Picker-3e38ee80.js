import{a as J,R as M,a3 as U,u as Q,E as W,i as H,r as X,w as Y,d as f,h as V,k as S,cf as G,cB as Z,an as j,l as x,U as I,j as C,b5 as ee,aq as B,H as te,n as z,ar as ne,as as L,aj as K,F as ie,T as ae,X as R,O as oe,I as $,V as se,e as b,p as O,q as a,a_ as re,b9 as le,aU as de,az as ce,al as pe,Y as q}from"./index-26b02238.js";var ue=function(w){J(i,w);function i(e){var t=w.call(this,e)||this;t.state={isOpened:!1,schema:t.buildSchema(t.props),isFocused:!1},t.input=M.createRef(),t.toDispose=[],t.mounted=!1;var o=e.formInited,n=e.addHook,s=e.formItem,l=function(){return V(t,void 0,void 0,function(){var r=this;return S(this,function(c){switch(c.label){case 0:return[4,this.fetchOptions()];case 1:return c.sent(),this.mounted&&this.toDispose.push(de(function(){return JSON.stringify(s==null?void 0:s.tmpValue)},function(){return r.fetchOptions()})),[2]}})})};return s&&t.toDispose.push(o||!n?s.addInitHook(l):n(l,"init")),t}return i.prototype.componentDidMount=function(){this.mounted=!0},i.prototype.componentDidUpdate=function(e){var t,o=this.props,n=["multiple","source","pickerSchema"];n.some(function(s){return!U(e[s],o[s])})?this.setState({schema:this.buildSchema(o)}):Q(e.source,o.source,e.data,o.data)&&!((t=o.formItem)===null||t===void 0)&&t.inited&&this.fetchOptions()},i.prototype.componentWillUnmount=function(){this.toDispose.forEach(function(e){return e()}),this.toDispose=[],this.mounted=!1},i.prototype.fetchOptions=function(){var e,t=this.props,o=t.value,n=t.formItem,s=t.valueField,l=t.labelField,r=t.source,c=t.data,u;if(!(!r||!n||(s||"value")===(l||"label")||(u=n.getSelectedOptions(o))&&(!u.length||u[0][s||"value"]!==u[0][l||"label"]))){var v=W(c,(e={value:o},e[s||"value"]=o,e.op="loadOptions",e));if(H(r))n.setOptions(X(r,c,"| raw"));else if(Y(r,v))return n.loadOptions(r,v,{autoAppend:!0})}},i.prototype.buildSchema=function(e){var t,o,n=H(e.source);return f(f({checkOnItemClick:!0,listItem:{title:"${".concat(e.labelField||"label","|raw}")}},e.pickerSchema),{labelTpl:(o=(t=e.pickerSchema)===null||t===void 0?void 0:t.labelTpl)!==null&&o!==void 0?o:e.labelTpl,type:"crud",pickerMode:!0,syncLocation:!1,filterCanAccessSuperData:!1,api:n?null:e.source,source:n?e.source:null,keepItemSelectionOnPageChange:!0,valueField:e.valueField,labelField:e.labelField,bulkActions:e.multiple?e.pickerSchema.bulkActions:[]})},i.prototype.crudRef=function(e){for(;e&&e.getWrappedInstance;)e=e.getWrappedInstance();this.crud=e},i.prototype.reload=function(){if(this.crud)this.crud.search();else{var e=this.props.reloadOptions;e&&e()}},i.prototype.open=function(){this.setState({isOpened:!0})},i.prototype.close=function(){this.setState({isOpened:!1})},i.prototype.handleModalConfirm=function(e,t,o,n){return V(this,void 0,void 0,function(){var s;return S(this,function(l){switch(l.label){case 0:return s=ce(n,function(r){return r.props.type==="crud"}),[4,this.handleChange(e[s].items)];case 1:return l.sent(),this.close(),[2]}})})},i.prototype.handleChange=function(e){return V(this,void 0,void 0,function(){var t,o,n,s,l,r,c,u,v,m,y,p,d,h;return S(this,function(k){switch(k.label){case 0:return t=this.props,o=t.joinValues,n=t.valueField,s=t.delimiter,l=t.extractValue,r=t.multiple,c=t.options,t.data,u=t.dispatchEvent,t.selectedOptions,v=t.setOptions,m=t.onChange,y=e,o?y=e.map(function(g){return g[n||"value"]}).join(s||","):l?y=r?e.map(function(g){return g[n||"value"]}):e[0]&&e[0][n||"value"]||"":y=r?e:e[0],p=[],e.forEach(function(g){pe(c,function(_){return g[n||"value"]==_[n||"value"]})||p.push(g)}),p.length&&v(c.concat(p)),d=r?e:e[0],[4,u("change",q(this.props,{value:y,option:d,selectedItems:d}))];case 1:return h=k.sent(),h!=null&&h.prevented?[2]:(m(y),[2])}})})},i.prototype.handleItemClick=function(e){return V(this,void 0,void 0,function(){var t,o,n,s;return S(this,function(l){switch(l.label){case 0:return t=this.props,o=t.data,n=t.dispatchEvent,[4,n("itemClick",W(o,{item:e}))];case 1:return s=l.sent(),s!=null&&s.prevented?[2]:[2]}})})},i.prototype.removeItem=function(e){return V(this,void 0,void 0,function(){var t,o,n,s,l,r,c,u,v,m,y,p,d,h;return S(this,function(k){switch(k.label){case 0:return t=this.props,o=t.selectedOptions,n=t.joinValues,s=t.extractValue,l=t.delimiter,r=t.valueField,c=t.onChange,u=t.multiple,v=t.dispatchEvent,m=o.concat(),y=K(m.splice(e,1),1),p=y[0],d=m,n?d=m.map(function(g){return g[r||"value"]}).join(l||","):s?d=u?m.map(function(g){return g[r||"value"]}):m[0]&&m[0][r||"value"]||"":d=u?m:m[0],[4,v("change",q(this.props,{value:d,option:p,selectedItems:p}))];case 1:return h=k.sent(),h!=null&&h.prevented?[2]:(c(d),[2])}})})},i.prototype.handleKeyDown=function(e){var t=this.props.selectedOptions;e.key===" "?(this.open(),e.preventDefault()):t.length&&e.key=="Backspace"&&this.removeItem(t.length-1)},i.prototype.handleFocus=function(e){this.input.current&&this.input.current.focus(),e.stopPropagation(),this.setState({isFocused:!0})},i.prototype.handleBlur=function(){this.setState({isFocused:!1})},i.prototype.handleClick=function(){this.open()},i.prototype.clearValue=function(e){e.stopPropagation();var t=this.props,o=t.onChange,n=t.resetValue;o(n!==void 0?n:"")},i.prototype.getOverflowConfig=function(){var e=this.props.overflowConfig;return G(i.defaultProps.overflowConfig,e)},i.prototype.handleSelect=function(e,t){var o=this.props,n=o.selectedOptions,s=o.valueField;if(!(!Array.isArray(e)||!Array.isArray(t)||!e.length&&!t.length)){var l=Z(e,n,function(r,c){var u=r[s||"value"],v=c[s||"value"];return u||v?u===v:U(j(r,"value"),j(c,"value"))});l.length===e.length&&l.length===n.length||this.handleChange(e)}},i.prototype.renderTag=function(e,t){var o=this,n=this.props,s=n.itemClearable,l=s===void 0?!0:s,r=n.classPrefix,c=n.classnames,u=n.labelField,v=n.labelTpl;n.translate;var m=n.disabled,y=n.env,p=n.id,d=n.themeCss,h=n.css;return x("div",{className:c("".concat(r,"Picker-value"),I(f(f({},this.props),{name:"pickValueWrapClassName",id:p,themeCss:d||h})),{"is-disabled":m}),children:[l&&C("span",{className:c("".concat(r,"Picker-valueIcon"),I(f(f({},this.props),{name:"pickValueIconClassName",id:p,themeCss:d||h}))),onClick:function(k){k.stopPropagation(),o.removeItem(t)},children:"×"}),C(ee,{inline:!1,tooltip:B(e,u||"label"),children:C("span",{className:c("".concat(r,"Picker-valueLabel"),I(f(f({},this.props),{name:"pickFontClassName",id:p,themeCss:d||h}))),onClick:function(k){k.stopPropagation(),o.handleItemClick(e)},children:v?C(te,{html:z(v,e),filterHtml:y.filterHtml}):"".concat(B(e,u||"label")||B(e,"id"))})})]},t)},i.prototype.renderValues=function(){var e=this,t=this.props,o=t.classPrefix,n=t.selectedOptions,s=t.translate,l=t.disabled,r=t.multiple,c=t.popOverContainer,u=t.id,v=t.themeCss,m=t.css,y=this.getOverflowConfig(),p=y.maxTagCount,d=y.overflowTagPopover,h=n.length,k=n,g=r!==!1&&ne(p,{start:0,end:h,left:"inclusive",right:"exclusive"});return g&&(k=L(L([],K(n.slice(0,p)),!1),[{label:"+ ".concat(h-p," ..."),value:"__overflow_tag__"}],!1)),C(ie,{children:k.map(function(_,P){return g&&P===p?C(ae,{container:c,tooltip:f(f({tooltipClassName:R("Picker-overflow",d==null?void 0:d.tooltipClassName),title:s("已选项")},j(d,["children","content","tooltipClassName"])),{children:function(){return C("div",{className:R("".concat(o,"Picker-overflow-wrapper")),children:n.slice(p,h).map(function(D,N){var T=N+p;return e.renderTag(D,T)})})}}),children:C("div",{className:R("".concat(o,"Picker-value"),{"is-disabled":l}),children:C("span",{className:"".concat(o,"Picker-valueLabel ").concat(I(f(f({},e.props),{name:"pickFontClassName",id:u,themeCss:v||m}))),children:_.label})},P)},P):e.renderTag(_,P)})})},i.prototype.overrideCRUDProps=function(){return{}},i.prototype.renderBody=function(e){var t=e===void 0?{}:e,o=t.popOverContainer,n=this.props,s=n.render,l=n.selectedOptions,r=n.options,c=n.multiple,u=n.valueField,v=n.embed,m=n.source,y=n.strictMode,p=n.testIdBuilder,d=this.getOverflowConfig(),h=d.maxTagCount,k=d.overflowTagPopoverInCRUD,g=d.displayPosition;return s("modal-body",this.state.schema,f(f({value:l,valueField:u,primaryField:u,options:m?[]:r,multiple:c,strictMode:y,onSelect:v?this.handleSelect:void 0,testIdBuilder:p==null?void 0:p.getChild("body-schema"),ref:this.crudRef,popOverContainer:o},v||Array.isArray(g)&&g.includes("crud")?{maxTagCount:h,overflowTagPopover:k}:{}),this.overrideCRUDProps()))},i.prototype.render=function(){var e=this.props,t=e.className;e.style;var o=e.modalClassName,n=e.classnames,s=e.disabled,l=e.render,r=e.modalMode,c=e.source,u=e.size,v=e.clearable,m=e.multiple,y=e.placeholder,p=e.embed,d=e.selectedOptions,h=e.translate,k=e.popOverContainer,g=e.modalTitle,_=e.data,P=e.mobileUI,D=e.env,N=e.themeCss,T=e.css,A=e.id,E=e.classPrefix,F=e.testIdBuilder;return x("div",{className:n("PickerControl",{"is-mobile":P},t),children:[p?C("div",{className:n("Picker"),children:this.renderBody({popOverContainer:k})}):x("div",{className:n("Picker",{"Picker--single":!m,"Picker--multi":m,"is-focused":this.state.isFocused,"is-disabled":s}),children:[x("div",{onClick:this.handleClick,className:n("Picker-input",s&&"is-disabled",this.state.isFocused&&"is-focused",I(f(f({},this.props),{name:"pickControlClassName",id:A,themeCss:N||T}))),children:[!d.length&&y?C("div",{className:n("Picker-placeholder"),children:h(y)}):x("div",{...f({className:n("Picker-valueWrap")},F==null?void 0:F.getTestId()),children:[this.renderValues(),C("input",{onChange:oe,value:"",ref:this.input,onKeyDown:this.handleKeyDown,onClick:this.handleFocus,onBlur:this.handleBlur,readOnly:P})]}),v&&!s&&d.length?C("a",{onClick:this.clearValue,className:n("Picker-clear"),children:C($,{icon:"input-clear",className:"icon"})}):null,C("span",{...f({onClick:this.open,className:n("Picker-btn")},F==null?void 0:F.getChild("picker-open-btn").getTestId()),children:C($,{icon:"window-restore",className:n("icon",I(f(f({},this.props),{name:"pickIconClassName",id:A,themeCss:N||T}))),iconContent:"Picker-icon"})})]}),l("modal",{title:g&&typeof g=="string"?z(g,_):h("Select.placeholder"),size:u,type:r,className:o,body:{children:this.renderBody},testIdBuilder:F==null?void 0:F.getChild("modal")},{key:"modal",lazyRender:!!c,onConfirm:this.handleModalConfirm,onClose:this.close,show:this.state.isOpened})]}),C(se,{...f({},this.props,{config:{themeCss:N||T,classNames:[{key:"pickControlClassName",weights:{default:{important:!0},hover:{important:!0},focused:{important:!0,parent:".".concat(E,"Picker.is-focused >")},disabled:{important:!0,parent:".".concat(E,"Picker.is-disabled >")}}},{key:"pickFontClassName"},{key:"pickValueWrapClassName",weights:{default:{important:!0}}},{key:"pickValueIconClassName",weights:{default:{important:!0},hover:{important:!0}}},{key:"pickIconClassName",weights:{default:{suf:" svg"}}}],id:A},env:D})})]})},i.propsList=["modalTitle","modalMode","pickerSchema","labelField","onChange","options","value","inline","multiple","embed","resetValue","placeholder","onQuery"],i.defaultProps={modalMode:"dialog",multiple:!1,placeholder:"Picker.placeholder",labelField:"label",valueField:"value",pickerSchema:{mode:"list"},embed:!1,overflowConfig:{maxTagCount:-1,displayPosition:["select","crud"],overflowTagPopover:{placement:"top",trigger:"hover",showArrow:!1,offset:[0,-5]},overflowTagPopoverInCRUD:{placement:"bottom",trigger:"hover",showArrow:!1,offset:[0,0]}}},b([O,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",Object)],i.prototype,"fetchOptions",null),b([O,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"crudRef",null),b([O,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"open",null),b([O,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"close",null),b([O,a("design:type",Function),a("design:paramtypes",[Array,Object,Object,Array]),a("design:returntype",Promise)],i.prototype,"handleModalConfirm",null),b([O,a("design:type",Function),a("design:paramtypes",[Array]),a("design:returntype",Promise)],i.prototype,"handleChange",null),b([O,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],i.prototype,"handleItemClick",null),b([O,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"handleKeyDown",null),b([O,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"handleFocus",null),b([O,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"handleBlur",null),b([O,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"handleClick",null),b([O,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"clearValue",null),b([O,a("design:type",Function),a("design:paramtypes",[Array,Array]),a("design:returntype",void 0)],i.prototype,"handleSelect",null),b([O,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"overrideCRUDProps",null),b([O,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"renderBody",null),b([re(),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"render",null),i}(M.PureComponent),ve=function(w){J(i,w);function i(){return w!==null&&w.apply(this,arguments)||this}return i=b([le({type:"picker",autoLoadOptionsFromSource:!1,sizeMutable:!1})],i),i}(ue);export{ve as PickerControlRenderer,ue as default};

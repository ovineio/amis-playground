import{g as H,a as U,u as Y,w as E,d as b,E as x,j as c,l as P,S as I,R as G,s as J,e as Q,f as X,q as Z}from"./index-12050af9.js";var R={exports:{}};(function($,u){Object.defineProperty(u,"__esModule",{value:!0});function r(t){return typeof t=="object"&&!("toString"in t)?Object.prototype.toString.call(t).slice(8,-1):t}var e=typeof process=="object"&&!0;function s(t,a){if(!t)throw e?new Error("Invariant failed"):new Error(a())}u.invariant=s;var d=Object.prototype.hasOwnProperty,y=Array.prototype.splice,T=Object.prototype.toString;function h(t){return T.call(t).slice(8,-1)}var v=Object.assign||function(t,a){return S(a).forEach(function(i){d.call(a,i)&&(t[i]=a[i])}),t},S=typeof Object.getOwnPropertySymbols=="function"?function(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.keys(t)};function l(t){return Array.isArray(t)?v(t.constructor(t.length),t):h(t)==="Map"?new Map(t):h(t)==="Set"?new Set(t):t&&typeof t=="object"?v(Object.create(Object.getPrototypeOf(t)),t):t}var C=function(){function t(){this.commands=v({},A),this.update=this.update.bind(this),this.update.extend=this.extend=this.extend.bind(this),this.update.isEquals=function(a,i){return a===i},this.update.newContext=function(){return new t().update}}return Object.defineProperty(t.prototype,"isEquals",{get:function(){return this.update.isEquals},set:function(a){this.update.isEquals=a},enumerable:!0,configurable:!0}),t.prototype.extend=function(a,i){this.commands[a]=i},t.prototype.update=function(a,i){var n=this,o=typeof i=="function"?{$apply:i}:i;Array.isArray(a)&&Array.isArray(o)||s(!Array.isArray(o),function(){return"update(): You provided an invalid spec to update(). The spec may not contain an array except as the value of $set, $push, $unshift, $splice or any custom command allowing an array value."}),s(typeof o=="object"&&o!==null,function(){return"update(): You provided an invalid spec to update(). The spec and every included key path must be plain objects containing one of the "+("following commands: "+Object.keys(n.commands).join(", ")+".")});var f=a;return S(o).forEach(function(m){if(d.call(n.commands,m)){var W=a===f;f=n.commands[m](o[m],f,o,a),W&&n.isEquals(f,a)&&(f=a)}else{var L=h(a)==="Map"?n.update(a.get(m),o[m]):n.update(a[m],o[m]),z=h(f)==="Map"?f.get(m):f[m];(!n.isEquals(L,z)||typeof L>"u"&&!d.call(a,m))&&(f===a&&(f=l(a)),h(f)==="Map"?f.set(m,L):f[m]=L)}}),f},t}();u.Context=C;var A={$push:function(t,a,i){return k(a,i,"$push"),t.length?a.concat(t):a},$unshift:function(t,a,i){return k(a,i,"$unshift"),t.length?t.concat(a):a},$splice:function(t,a,i,n){return _(a,i),t.forEach(function(o){w(o),a===n&&o.length&&(a=l(n)),y.apply(a,o)}),a},$set:function(t,a,i){return B(i),t},$toggle:function(t,a){g(t,"$toggle");var i=t.length?l(a):a;return t.forEach(function(n){i[n]=!a[n]}),i},$unset:function(t,a,i,n){return g(t,"$unset"),t.forEach(function(o){Object.hasOwnProperty.call(a,o)&&(a===n&&(a=l(n)),delete a[o])}),a},$add:function(t,a,i,n){return N(a,"$add"),g(t,"$add"),h(a)==="Map"?t.forEach(function(o){var f=o[0],m=o[1];a===n&&a.get(f)!==m&&(a=l(n)),a.set(f,m)}):t.forEach(function(o){a===n&&!a.has(o)&&(a=l(n)),a.add(o)}),a},$remove:function(t,a,i,n){return N(a,"$remove"),g(t,"$remove"),t.forEach(function(o){a===n&&a.has(o)&&(a=l(n)),a.delete(o)}),a},$merge:function(t,a,i,n){return q(a,t),S(t).forEach(function(o){t[o]!==a[o]&&(a===n&&(a=l(n)),a[o]=t[o])}),a},$apply:function(t,a){return M(t),t(a)}},p=new C;u.isEquals=p.update.isEquals,u.extend=p.extend,u.default=p.update,u.default.default=$.exports=v(u.default,u);function k(t,a,i){s(Array.isArray(t),function(){return"update(): expected target of "+r(i)+" to be an array; got "+r(t)+"."}),g(a[i],i)}function g(t,a){s(Array.isArray(t),function(){return"update(): expected spec of "+r(a)+" to be an array; got "+r(t)+". Did you forget to wrap your parameter in an array?"})}function _(t,a){s(Array.isArray(t),function(){return"Expected $splice target to be an array; got "+r(t)}),w(a.$splice)}function w(t){s(Array.isArray(t),function(){return"update(): expected spec of $splice to be an array of arrays; got "+r(t)+". Did you forget to wrap your parameters in an array?"})}function M(t){s(typeof t=="function",function(){return"update(): expected spec of $apply to be a function; got "+r(t)+"."})}function B(t){s(Object.keys(t).length===1,function(){return"Cannot have more than one key in an object with $set"})}function q(t,a){s(a&&typeof a=="object",function(){return"update(): $merge expects a spec of type 'object'; got "+r(a)}),s(t&&typeof t=="object",function(){return"update(): $merge expects a target of type 'object'; got "+r(t)})}function N(t,a){var i=h(t);s(i==="Map"||i==="Set",function(){return"update(): "+r(a)+" expects a target of type Set or Map; got "+r(i)})}})(R,R.exports);var F=R.exports;const D=H(F);var K=function($){U(u,$);function u(r){var e=$.call(this,r)||this;return e.state={items:r.items?r.items.concat():[]},e.handleLoaded=e.handleLoaded.bind(e),e.tick=e.tick.bind(e),e}return u.prototype.componentDidMount=function(){this.tick(!!this.props.checkApi)},u.prototype.componentDidUpdate=function(r){var e=this.props;r.items!==e.items?this.setState({items:e.items?e.items.concat():[]}):Y(r.checkApi,e.checkApi,r.data,e.data)&&this.tick(!0)},u.prototype.componentWillUnmount=function(){clearTimeout(this.timer)},u.prototype.reload=function(){this.tick(!0)},u.prototype.tick=function(r){var e=this;r===void 0&&(r=!1);var s=this.props,d=s.loadingStatusCode,y=s.data,T=s.interval,h=s.checkApi,v=s.env,S=this.state.items;if(clearTimeout(this.timer),!(!r&&!S.some(function(l){return l.status===d}))){if(T&&!E(h))return v.alert("checkApi 没有设置, 不能及时获取任务状态");E(h,y)&&v&&v.fetcher(h,y).then(this.handleLoaded).catch(function(l){return e.setState({error:l})})}},u.prototype.handleLoaded=function(r){if(!Array.isArray(r.data))return this.props.env.alert("返回格式不正确, 期望 response.data 为数组, 包含每个 task 的状态信息");this.setState({items:r.data});var e=this.props.interval;clearTimeout(this.timer),this.timer=setTimeout(this.tick,e)},u.prototype.submitTask=function(r,e,s){var d=this;s===void 0&&(s=!1);var y=this.props,T=y.submitApi,h=y.reSubmitApi,v=y.loadingStatusCode,S=y.errorStatusCode,l=y.data,C=y.env;if(!s&&!E(T))return C.alert("submitApi 没有配置");if(s&&!E(h))return C.alert("reSubmitApi 没有配置");this.setState(D(this.state,{items:{$splice:[[e,1,b(b({},r),{status:v})]]}}));var A=s?h:T;E(A,l)&&C&&C.fetcher(A,x(l,r)).then(function(p){if(p&&p.data){if(Array.isArray(p.data))d.handleLoaded(p);else{A&&A.replaceData;var k=d.state.items.map(function(g){return g.key===p.data.key?b(b({},A.replaceData?{}:g),p.data):g});d.handleLoaded(b(b({},p),{data:k}))}return}clearTimeout(d.timer),d.timer=setTimeout(d.tick,4)}).catch(function(p){return d.setState(D(d.state,{items:{$splice:[[e,1,b(b({},r),{status:S,remark:p.message||p})]]}}))})},u.prototype.render=function(){var r=this,e=this.props,s=e.classnames,d=e.className,y=e.style,T=e.tableClassName,h=e.taskNameLabel,v=e.operationLabel,S=e.statusLabel,l=e.remarkLabel,C=e.btnText,A=e.retryBtnText,p=e.btnClassName,k=e.retryBtnClassName,g=e.statusLabelMap,_=e.statusTextMap,w=e.readyStatusCode,M=e.loadingStatusCode,B=e.canRetryStatusCode,q=e.translate,N=e.render,t=e.loadingConfig,a=this.state.items,i=this.state.error;return c("div",{className:s("Table-content",d),style:y,children:P("table",{className:s("Table-table",T),children:[c("thead",{children:P("tr",{children:[c("th",{children:h}),c("th",{children:q(v)}),c("th",{children:S}),c("th",{children:l})]})}),c("tbody",{children:i?c("tr",{children:c("td",{colSpan:4,children:c("div",{className:"text-danger",children:i})})}):a.map(function(n,o){return P("tr",{children:[c("td",{children:c("span",{className:s("word-break"),children:n.label})}),c("td",{children:n.status==M?c(I,{loadingConfig:t,show:!0,icon:"reload",spinnerClassName:s("Task-spinner")}):n.status==B?c("a",{onClick:function(){return r.submitTask(n,o,!0)},className:s("Button","Button--danger","Button--size-md",k||p),children:A||C}):c("a",{onClick:function(){return r.submitTask(n,o)},className:s("Button","Button--default","Button--size-md",p,{disabled:n.status!==w}),children:C})}),c("td",{children:c("span",{className:s("label",g&&g[n.status||0]),children:_&&_[n.status||0]})}),c("td",{children:n.remark?N("".concat(o,"/remark"),n.remark):null})]},o)})})]})})},u.defaultProps={className:"",tableClassName:"",taskNameLabel:"任务名称",operationLabel:"Table.operation",statusLabel:"状态",remarkLabel:"备注说明",btnText:"上线",retryBtnText:"重试",btnClassName:"",retryBtnClassName:"",statusLabelMap:["label-warning","label-info","label-info","label-danger","label-success","label-danger"],statusTextMap:["未开始","就绪","进行中","出错","已完成","出错"],initialStatusCode:0,readyStatusCode:1,loadingStatusCode:2,errorStatusCode:3,finishStatusCode:4,canRetryStatusCode:5,interval:3e3},u}(G.Component),O=function($){U(u,$);function u(r,e){var s=$.call(this,r)||this,d=e;return d.registerComponent(s),s}return u.prototype.componentWillUnmount=function(){$.prototype.componentWillUnmount.call(this);var r=this.context;r.unRegisterComponent(this)},u.contextType=J,u=Q([X({type:"tasks"}),Z("design:paramtypes",[Object,Object])],u),u}(K);export{O as TaskRenderer,K as default};

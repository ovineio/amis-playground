import{a as K,w as R,di as P,bz as M,dj as Q,E as N,a3 as $,u as U,h as k,k as D,d as w,ac as I,j,dk as X,F as G,l as B,as as Y,aj as Z,S as q,e as O,p as x,q as c,R as tt,ak as et,s as at,f as nt,cW as it,cd as rt,n as V,J,dl as z}from"./index-12050af9.js";var st=function(A){K(r,A);function r(){var e=A!==null&&A.apply(this,arguments)||this;return e.initalValues={},e.state={currentStep:-1,completeStep:-1,rawSteps:[]},e}return r.prototype.componentDidMount=function(){var e=this,t=this.props,a=t.initApi,n=t.initFetch,s=t.initAsyncApi,o=t.initFinishedField,p=t.store,h=t.messages,l=h.fetchSuccess,u=h.fetchFailed;t.onInit,R(a,p.data,n)?p.fetchInitData(a,p.data,{successMessage:l,errorMessage:u,onSuccess:function(){if(!(!R(s,p.data)||p.data[o||"finished"]))return P(function(){return p.checkRemote(s,p.data)},function(i){return i&&i[o||"finished"]},function(i){return e.asyncCancel=i})}}).then(function(i){e.handleFetchInitEvent(i);var m={currentStep:typeof e.props.startStep=="string"?M(Q(e.props.startStep,N(e.props.data,(i==null?void 0:i.data)||{})),1):1};return i&&i.data&&(typeof i.data.step=="number"||typeof i.data.step=="string"&&/^\d+$/.test(i.data.step))&&(m.currentStep=M(i.data.step,1)),e.setState(m,function(){i&&i.data&&(i.data.submiting||i.data.submited)&&e.checkSubmit()}),i}):this.setState({currentStep:typeof this.props.startStep=="string"?M(Q(this.props.startStep,this.props.data),1):1}),this.normalizeSteps(p.data)},r.prototype.componentDidUpdate=function(e){var t=this.props,a=t.store,n=t.fetchSuccess,s=t.fetchFailed;(!$(e.steps,t.steps)||!$(e.data,t.data))&&this.normalizeSteps(t.data),U(e.initApi,t.initApi,e.data,t.data)&&a.fetchData(t.initApi,a.data,{successMessage:n,errorMessage:s})},r.prototype.componentWillUnmount=function(){this.asyncCancel&&this.asyncCancel()},r.prototype.dispatchEvent=function(e,t){var a;return k(this,void 0,void 0,function(){var n,s,o,p;return D(this,function(h){switch(h.label){case 0:return n=this.props,s=n.dispatchEvent,o=n.data,[4,s(e,t?N(o,t):o)];case 1:return p=h.sent(),[2,(a=p==null?void 0:p.prevented)!==null&&a!==void 0?a:!1]}})})},r.prototype.handleFetchInitEvent=function(e){var t;return k(this,void 0,void 0,function(){var a,n,s;return D(this,function(o){switch(o.label){case 0:return a=this.props,n=a.onInit,s=a.store,[4,this.dispatchEvent("inited",w(w({},s.data),{responseData:e.ok?(t=s.data)!==null&&t!==void 0?t:{}:e,responseStatus:(e==null?void 0:e.status)===void 0?s.error?1:0:e==null?void 0:e.status,responseMsg:s.msg}))];case 1:return o.sent()&&n&&n(s.data),[2]}})})},r.prototype.normalizeSteps=function(e){return k(this,void 0,void 0,function(){var t,a,n,s,o,p,h;return D(this,function(l){switch(l.label){case 0:t=this.props,a=t.steps,n=t.translate,s=[],o=a.length,p=0,l.label=1;case 1:return p<o?[4,rt(a[p].hiddenOn,e)]:[3,4];case 2:h=l.sent(),!h&&s.push(a[p]),l.label=3;case 3:return p++,[3,1];case 4:return this.setState({rawSteps:s.map(function(u,i){return w(w({},u),{hiddenOn:"",title:u.title||u.label||n("Steps.step",{index:i+1})})})}),[2]}})})},r.prototype.gotoStep=function(e){return k(this,void 0,void 0,function(){var t;return D(this,function(a){switch(a.label){case 0:return t=this.state.rawSteps,e=Math.max(Math.min(t.length,e),1),e==this.state.currentStep?[3,2]:[4,this.dispatchEvent("stepChange",{step:e})];case 1:if(a.sent())return[2];this.setState({currentStep:e,completeStep:Math.max(this.state.completeStep,e-1)}),a.label=2;case 2:return[2]}})})},r.prototype.formRef=function(e){if(e){for(;e&&e.getWrappedInstance;)e=e.getWrappedInstance();this.form=e}else this.form=void 0},r.prototype.submitToTarget=function(e,t){throw new Error("Please implements this!")},r.prototype.reloadTarget=function(e,t){throw new Error("Please implements this!")},r.prototype.reload=function(e,t,a,n,s){return k(this,void 0,void 0,function(){var o,p,h,l,u,i,m,f,d,v,g=this;return D(this,function(C){switch(C.label){case 0:return t?[2,this.receive(t,void 0,s)]:(o=this.props,p=o.initApi,h=o.initAsyncApi,l=o.initFinishedField,u=o.store,i=o.messages,m=i.fetchSuccess,f=i.fetchFailed,R(p,u.data)&&this.state.currentStep===1?[4,u.fetchInitData(p,u.data,{successMessage:m,errorMessage:f,onSuccess:function(){if(!(!R(h,u.data)||u.data[l||"finished"]))return P(function(){return u.checkRemote(h,u.data)},function(F){return F&&F[l||"finished"]},function(F){return g.asyncCancel=F})}})]:[3,2]);case 1:d=C.sent(),v={currentStep:1},d&&d.data&&(typeof d.data.step=="number"||typeof d.data.step=="string"&&/^\d+$/.test(d.data.step))&&(v.currentStep=M(d.data.step,1)),this.setState(v,function(){d&&d.data&&(d.data.submiting||d.data.submited)&&g.checkSubmit()}),C.label=2;case 2:return[2,u.data]}})})},r.prototype.receive=function(e,t,a){var n=this.props.store;return n.updateData(e,void 0,a),this.reload()},r.prototype.domRef=function(e){this.dom=e},r.prototype.getPopOverContainer=function(){return this.dom},r.prototype.checkSubmit=function(){var e,t=this,a=this.props,n=a.store,s=a.asyncApi,o=a.finishedField,p=a.env,h=this.state.rawSteps,l=h[this.state.currentStep-1],u=l&&l.asyncApi||this.state.currentStep===h.length&&s;!l||!R(u,n.data)||(n.markSaving(!0),n.updateData((e={},e[o||"finished"]=!1,e)),P(function(){return n.checkRemote(u,n.data)},function(i){return i&&i[o||"finished"]},function(i){return t.asyncCancel=i}).then(function(){n.markSaving(!1),t.gotoStep(t.state.currentStep+1)}).catch(function(i){!u.silent&&p.notify("error",i.message),n.markSaving(!1)}))},r.prototype.handleAction=function(e,t,a,n,s){var o=this;n===void 0&&(n=!1);var p=this.props,h=p.onAction,l=p.store,u=p.env,i=this.state.rawSteps;if(t.actionType==="next"||t.type==="submit"||t.actionType==="step-submit")this.form.doAction(w(w({},t),{actionType:"submit"}),a);else if(t.actionType==="prev")this.gotoStep(this.state.currentStep-1);else if(t.type==="reset")this.form.reset();else{if(t.actionType==="dialog")return l.setCurrentAction(t,this.props.resolveDefinitions),new Promise(function(f){l.openDialog(a,void 0,function(d,v){var g;(g=t.callback)===null||g===void 0||g.call(t,d,v),f({confirmed:d,value:v})},s||o.context)});if(t.actionType==="ajax")return t.api?l.saveRemote(t.api,a,{successMessage:t.messages&&t.messages.success,errorMessage:t.messages&&t.messages.failed}).then(function(){return k(o,void 0,void 0,function(){var f,d,v;return D(this,function(g){switch(g.label){case 0:return this.form&&this.form.isValidated()&&this.form.validate(!0),f=t.feedback,f&&J(f,l.data)?[4,this.openFeedback(f,l.data)]:[3,2];case 1:if(d=g.sent(),f.skipRestOnCancel&&!d)throw new z;if(f.skipRestOnConfirm&&d)throw new z;g.label=2;case 2:return v=t.redirect&&V(t.redirect,l.data),v&&u.jumpTo(v,t,l.data),t.reload&&this.reloadTarget(I(t.reload,l.data),l.data),[2]}})})}).catch(function(f){}):u.alert("当 actionType 为 ajax 时，请设置 api 属性");if(t.actionType==="reload")t.target&&this.reloadTarget(I(t.target,a),a);else if(t.actionType==="goto-step"){var m=a.step;m!==void 0&&m<=i.length&&m>=0&&this.gotoStep(a.step)}else t.actionType==="submit"?this.finalSubmit():h&&h(e,t,a,n,s||this.context)}},r.prototype.handleQuery=function(e){if(this.props.initApi){if(e!=null&&e.hasOwnProperty("orderBy")&&!U(this.props.initApi,this.props.initApi,this.props.store.data,N(this.props.store.data,e)))return!1;this.receive(e);return}return this.props.onQuery?this.props.onQuery(e):!1},r.prototype.openFeedback=function(e,t){var a=this;return new Promise(function(n){var s=a.props.store;s.setCurrentAction({type:"button",actionType:"dialog",dialog:e},a.props.resolveDefinitions),s.openDialog(t,void 0,function(o){n(o)},a.context)})},r.prototype.handleChange=function(e){return k(this,void 0,void 0,function(){var t,a,n;return D(this,function(s){switch(s.label){case 0:return t=this.props.store,a=t.data,n=w(w({},a),e),[4,this.dispatchEvent("change",n)];case 1:return s.sent()?[2]:(t.updateData(e),[2])}})})},r.prototype.handleInit=function(e){var t=this.state.currentStep;this.initalValues[t]=this.initalValues[t]||e;var a=this.props.store;a.updateData(e)},r.prototype.handleReset=function(e){var t=this.props.store,a=this.initalValues[this.state.currentStep],n={};Object.keys(e).forEach(function(s){n[s]=a.hasOwnProperty(s)?a[s]:void 0}),t.updateData(n)},r.prototype.finalSubmit=function(e,t){return e===void 0&&(e={}),t===void 0&&(t={type:"submit"}),k(this,void 0,void 0,function(){var a,n,s,o,p,h,l,u,i,m,f,d,v,g,C,F,b=this;return D(this,function(_){switch(_.label){case 0:return a=this.props,n=a.store,s=a.api,o=a.asyncApi,p=a.finishedField,h=a.target,l=a.redirect,u=a.reload,i=a.env,m=a.onFinished,f=this.state.rawSteps,[4,this.dispatchEvent("finished",n.data)];case 1:if(_.sent())return[2];if(d=f[this.state.currentStep-1],n.updateData(e),h)this.submitToTarget(I(h,n.data),n.data),this.setState({completeStep:f.length});else if(t.api||d.api||s)v=t.asyncApi||d.asyncApi||o,R(v,n.data)&&n.updateData((F={},F[p||"finished"]=!1,F)),g=this.form?this.form.props.store:n,n.markSaving(!0),g.saveRemote(t.api||d.api||s,n.data,{onSuccess:function(y){return k(b,void 0,void 0,function(){var S,T,E=this;return D(this,function(W){switch(W.label){case 0:return[4,this.dispatchEvent("submitSucc",N(this.props.data,{result:y}))];case 1:return S=W.sent(),!R(v,n.data)||n.data[p||"finished"]?[2,{cbResult:null,dispatcher:S}]:(T=P(function(){return n.checkRemote(v,n.data)},function(L){return L&&L[p||"finished"]},function(L){return E.asyncCancel=L}),[2,{cbResult:T,dispatcher:S}])}})})},onFailed:function(y){return k(b,void 0,void 0,function(){var S;return D(this,function(T){switch(T.label){case 0:return n.markSaving(!1),[4,this.dispatchEvent("submitFail",N(this.props.data,{error:y}))];case 1:return S=T.sent(),[2,{dispatcher:S}]}})})}}).then(function(y){return k(b,void 0,void 0,function(){var S,T,E;return D(this,function(W){switch(W.label){case 0:return S=t.feedback,S&&J(S,y)?[4,this.openFeedback(S,y)]:[3,2];case 1:if(T=W.sent(),S.skipRestOnCancel&&!T)throw new z;if(S.skipRestOnConfirm&&T)throw new z;W.label=2;case 2:if(this.setState({completeStep:f.length}),n.updateData(w(w({},n.data),y)),n.markSaving(!1),y&&typeof y.step=="number")this.gotoStep(y.step);else if(m&&m(y,t)===!1)return[2,y];return E=(t.redirect||d.redirect||l)&&V(t.redirect||d.redirect||l,n.data),E?i.jumpTo(E,t,n.data):(t.reload||d.reload||u)&&this.reloadTarget(I(t.reload||d.reload||u,n.data),n.data),[2,y]}})})}).catch(function(y){});else{if(this.setState({completeStep:f.length}),m&&m(n.data,t)===!1)return[2];C=(t.redirect||d.redirect||l)&&V(t.redirect||d.redirect||l,n.data),C?i.jumpTo(C,t,n.data):(t.reload||d.reload||u)&&this.reloadTarget(I(t.reload||d.reload||u,n.data),n.data)}return[2]}})})},r.prototype.handleSubmit=function(e,t){var a,n=this,s=this.props,o=s.store,p=s.finishedField,h=this.state.rawSteps;if(this.state.currentStep<h.length){var l=h[this.state.currentStep-1];o.updateData(e);var u=t.asyncApi||l.asyncApi;R(u,o.data)&&o.updateData((a={},a[p||"finished"]=!1,a)),R(t.api||l.api,o.data)?o.saveRemote(t.api||l.api,o.data,{onSuccess:function(){if(n.dispatchEvent("stepSubmitSucc"),!(!R(u,o.data)||o.data[p||"finished"]))return P(function(){return o.checkRemote(u,o.data)},function(i){return i&&i[p||"finished"]},function(i){return n.asyncCancel=i})},onFailed:function(i){n.dispatchEvent("stepSubmitFail",{error:i}),i.status===422&&i.errors&&n.form&&n.form.props.store.setFormItemErrors(i.errors)}}).then(function(i){return k(n,void 0,void 0,function(){var m,f;return D(this,function(d){switch(d.label){case 0:return m=t.feedback,m&&J(m,i)?[4,this.openFeedback(m,i)]:[3,2];case 1:if(f=d.sent(),m.skipRestOnCancel&&!f)throw new z;if(m.skipRestOnConfirm&&f)throw new z;d.label=2;case 2:return this.gotoStep(i&&typeof i.step=="number"?i.step:this.state.currentStep+1),[2]}})})}).catch(function(i){n.dispatchEvent("stepSubmitFail",{error:i})}):this.gotoStep(this.state.currentStep+1)}else this.finalSubmit(e,t);return!1},r.prototype.handleDialogConfirm=function(e,t,a){var n=this.props.store;t.mergeData&&e.length===1&&e[0]&&a[0].props.type==="form"&&n.updateData(e[0]),n.closeDialog(!0,e)},r.prototype.handleDialogClose=function(e){e===void 0&&(e=!1);var t=this.props.store;t.closeDialog(e)},r.prototype.handleJumpStep=function(e,t){var a=this.props.store,n=this.state.currentStep,s=H(t,e,n,a.data);s&&this.gotoStep(e+1)},r.prototype.renderSteps=function(){var e=this.props,t=e.mode,a=e.classPrefix,n=e.classnames,s=e.stepsClassName,o=this.state,p=o.currentStep,h=o.rawSteps;return j("div",{className:n("".concat(a,"-Wizard-steps"),s),id:"form-wizard",children:Array.isArray(h)&&h.length?j(X,{steps:h,mode:t,current:p-1,onClickStep:this.handleJumpStep}):null})},r.prototype.renderActions=function(){var e=this,t=this.props,a=t.store,n=t.readOnly,s=t.disabled,o=t.actionClassName,p=t.actionPrevLabel,h=t.actionNextLabel,l=t.actionNextSaveLabel,u=t.actionFinishLabel,i=t.render,m=t.translate;t.classnames;var f=t.testIdBuilder,d=this.state.rawSteps;if(!Array.isArray(d))return null;var v=this.state.currentStep,g=d[v],C=d[v-2],F=a.loading,b=d[v-1];if(!b)return null;var _=C?H(C,v-2,v,a.data):!1;return b.actions&&Array.isArray(b.actions)?b.actions.length?j(G,{children:b.actions.map(function(y,S){return i("action/".concat(S),y,{key:S,data:N(e.props.data,{currentStep:v}),onAction:e.handleAction,disabled:y.disabled||F||s||y.actionType==="prev"&&!_||y.actionType==="next"&&n&&(!!b.api||!g)})})}):null:B(G,{children:[i("prev-btn",{type:"button",label:m(p),actionType:"prev",className:o,hiddenOn:"${currentStep === 1}",id:f==null?void 0:f.getChild("button-prev").getTestIdValue()},{disabled:F||!_||s,onAction:this.handleAction,data:N(this.props.data,{currentStep:v})}),i("next-btn",{type:"button",label:g?b.api?m(l):m(h):m(u),actionType:"next",primary:!g||!!b.api,className:o,level:"primary",id:f==null?void 0:f.getChild("button-next").getTestIdValue()},{disabled:F||s||n&&(!!b.api||!g),onAction:this.handleAction})]})},r.prototype.renderFooter=function(){var e=this.renderActions();if(!e)return e;var t=this.props,a=t.classnames,n=t.affixFooter,s=t.footerClassName,o=t.wrapWithPanel;return j("div",{role:"wizard-footer",className:a("Wizard-footer",o?"Panel-footer":"",n&&o?"Panel-fixedBottom":"",s),children:e})},r.prototype.renderWizard=function(){var e=this.props,t=e.className,a=e.steps,n=e.style,s=e.render,o=e.store,p=e.classPrefix,h=e.classnames,l=e.popOverContainer,u=e.mode,i=e.translate,m=e.loadingConfig,f=e.stepClassName,d=e.bodyClassName,v=e.wrapWithPanel,g=this.state,C=g.rawSteps,F=g.currentStep,b=Array.isArray(C)&&C.length>0?C:Array.isArray(a)?Y([],Z(a),!1).map(function(y){return delete y.hiddenOn,y}):null,_=Array.isArray(b)?b[F-1]:null;return B("div",{ref:this.domRef,className:h(v?"".concat(p,"Panel ").concat(p,"Panel--default"):"","".concat(p,"Wizard ").concat(p,"Wizard--").concat(u),t),style:n,children:[B("div",{className:h("".concat(p,"Wizard-step"),f),children:[this.renderSteps(),j("div",{role:"wizard-body",className:h("".concat(p,"Wizard-stepContent clearfix"),d),children:_?s("body",w(w({},_),{type:"form",wrapWithPanel:!1,api:null}),{key:this.state.currentStep,ref:this.formRef,onInit:this.handleInit,onReset:this.handleReset,onSubmit:this.handleSubmit,onAction:this.handleAction,onQuery:this.handleQuery,disabled:o.loading,popOverContainer:l||this.getPopOverContainer,onChange:this.handleChange,formStore:void 0}):F===-1?i("loading"):j("p",{className:"text-danger",children:i("Wizard.configError")})}),this.renderFooter()]}),s("dialog",w(w({},o.action&&o.action.dialog),{type:"dialog"}),{key:"dialog",data:o.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:o.dialogOpen}),j(q,{loadingConfig:m,size:"lg",overlay:!0,show:o.loading},"info")]})},r.prototype.render=function(){return this.renderWizard()},r.defaultProps={mode:"horizontal",readOnly:!1,messages:{},actionClassName:"",actionPrevLabel:"Wizard.prev",actionNextLabel:"Wizard.next",actionNextSaveLabel:"Wizard.saveAndNext",actionFinishLabel:"Wizard.finish",startStep:"1",wrapWithPanel:!0},r.propsList=["steps","mode","messages","actionClassName","actionPrevLabel","actionNextLabel","actionNextSaveLabel","actionFinishLabel","onFinished","affixFooter","startStep"],O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",void 0)],r.prototype,"formRef",null),O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",void 0)],r.prototype,"domRef",null),O([x,c("design:type",Function),c("design:paramtypes",[]),c("design:returntype",void 0)],r.prototype,"getPopOverContainer",null),O([x,c("design:type",Function),c("design:paramtypes",[Object,Object,Object,Boolean,Object]),c("design:returntype",void 0)],r.prototype,"handleAction",null),O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",void 0)],r.prototype,"handleQuery",null),O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",Promise)],r.prototype,"handleChange",null),O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",void 0)],r.prototype,"handleInit",null),O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",void 0)],r.prototype,"handleReset",null),O([x,c("design:type",Function),c("design:paramtypes",[Object,Object]),c("design:returntype",void 0)],r.prototype,"handleSubmit",null),O([x,c("design:type",Function),c("design:paramtypes",[Array,Object,Array]),c("design:returntype",void 0)],r.prototype,"handleDialogConfirm",null),O([x,c("design:type",Function),c("design:paramtypes",[Object]),c("design:returntype",void 0)],r.prototype,"handleDialogClose",null),O([x,c("design:type",Function),c("design:paramtypes",[Number,Object]),c("design:returntype",void 0)],r.prototype,"handleJumpStep",null),r}(tt.Component);function H(A,r,e,t){var a=!1;return A&&A.hasOwnProperty("jumpable")?a=A.jumpable:A&&A.jumpableOn?a=et(A.jumpableOn,N(t,{currentStep:e})):a=r+1<e,a}var pt=function(A){K(r,A);function r(e,t){var a=A.call(this,e)||this,n=t;return n.registerComponent(a),a}return r.prototype.componentWillUnmount=function(){var e=this.context;e.unRegisterComponent(this),A.prototype.componentWillUnmount.call(this)},r.prototype.doAction=function(e,t,a){return this.handleAction(void 0,e,t)},r.prototype.submitToTarget=function(e,t){var a=this.context;a.send(e,t)},r.prototype.reloadTarget=function(e,t){var a=this.context;a.reload(e,t)},r.prototype.handleDialogConfirm=function(e,t,a){A.prototype.handleDialogConfirm.call(this,e,t,a);var n=this.props.store,s=this.context;t.reload?s.reload(t.reload,n.data):n.action&&n.action.reload&&s.reload(n.action.reload,n.data)},r.prototype.setData=function(e,t){return this.props.store.updateData(e,void 0,t)},r.prototype.getData=function(){var e=this.props.store;return e.data},r.contextType=at,O([x,c("design:type",Function),c("design:paramtypes",[Array,Object,Array]),c("design:returntype",void 0)],r.prototype,"handleDialogConfirm",null),r=O([nt({type:"wizard",storeType:it.name,isolateScope:!0}),c("design:paramtypes",[Object,Object])],r),r}(st);export{pt as WizardRenderer,st as default};
